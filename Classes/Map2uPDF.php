<?php

namespace Map2u\CoreBundle\Classes;

//include_once 'vendor\tcpdf\tcpdf.php';
//use WriteOctober\TCPDFbundle\Controller\TCPDF;
use \TCPDF; 

/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

class Map2uPDF extends TCPDF {

  public $footertext = '';

//Page header
  public function Header() {
// Logo
    //        parent::Header();
    if ($this->header_xobjid < 0) {
      // start a new XObject Template
      $this->header_xobjid = $this->startTemplate($this->w, $this->tMargin);
      $headerfont = $this->getHeaderFont();
      $headerdata = $this->getHeaderData();
      $this->y = $this->header_margin;
      if ($this->rtl) {
        $this->x = $this->w - $this->original_rMargin;
      }
      else {
        $this->x = $this->original_lMargin;
      }
      if (($headerdata['logo']) AND ( $headerdata['logo'] != K_BLANK_IMAGE)) {
        $this->setImage($headerdata);
        $imgy = $this->getImageRBY();
      }
      else {
        $imgy = $this->y;
      }
      $cellHeight = round(($this->cell_height_ratio * $headerfont[2]) / $this->k, 2);
      // set starting margin for text data cell
      if ($this->getRTL()) {
        $headerX = $this->original_rMargin + ($headerdata['logo_width'] * 1.1);
      }
      else {
        $headerX = $this->original_lMargin + ($headerdata['logo_width'] * 1.1);
      }
      $cellWidth = $this->w - $this->original_lMargin - $this->original_rMargin - ($headerdata['logo_width'] * 1.1);
      $this->SetTextColorArray($this->header_text_color);
      // header title
      $this->SetFont($headerfont[0], 'B', $headerfont[2] + 1);
      $this->SetX($headerX);
      $this->Cell($cellWidth, $cellHeight, $headerdata['title'], 0, 1, '', 0, '', 0);
      // header string
      $this->SetFont($headerfont[0], $headerfont[1], $headerfont[2]);
      $this->SetX($headerX);
      $this->MultiCell($cellWidth, $cellHeight, $headerdata['string'], 0, '', 0, 1, '', '', true, 0, false, true, 0, 'T', false);
      // print an ending header line
      $this->SetLineStyle(array('width' => 0.85 / $this->k, 'cap' => 'butt', 'join' => 'miter', 'dash' => 0, 'color' => $headerdata['line_color']));
      //	$this->SetY((2.835 / $this->k) + max($imgy, $this->y));
      // set header line margin, modified
      $this->SetY((2.835 / $this->k) + max($imgy, $this->y) - 3.0);
      if ($this->rtl) {
        $this->SetX($this->original_rMargin);
      }
      else {
        $this->SetX($this->original_lMargin);
      }
      // modified by joseph zhao
      $this->Cell(($this->w - $this->original_lMargin - $this->original_rMargin), 0, '', 'T', 0, 'C');
      //		$this->Cell(($this->w - $this->original_lMargin - $this->original_rMargin), 0, '', 'T', 0, 'C');
      $this->endTemplate();
    }

    // print header template
    $x = 0;
    $dx = 0;
    if (!$this->header_xobj_autoreset AND $this->booklet AND ( ($this->page % 2) == 0)) {
      // adjust margins for booklet mode
      $dx = ($this->original_lMargin - $this->original_rMargin);
    }
    if ($this->rtl) {
      $x = $this->w + $dx;
    }
    else {
      $x = 0 + $dx;
    }
    $this->printTemplate($this->header_xobjid, $x, 0, 0, 0, '', '', false);
    if ($this->header_xobj_autoreset) {
      // reset header xobject template at each page
      $this->header_xobjid = -1;
    }
  }

// Page footer
  public function Footer() {
//            parent::Footer();
    $curY = $this->y;
    $this->SetTextColorArray($this->footer_text_color);
    //set style for cell border
    $lineWidth = (0.85 / $this->k);
    $this->SetLineStyle(array('width' => $lineWidth, 'cap' => 'butt', 'join' => 'miter', 'dash' => 0, 'color' => $this->footer_line_color));
    //print document barcode
    $barcode = $this->getBarcode();
    if (!empty($barcode)) {
      $this->Ln($lineWidth);
      //	$barcodeWidth = round(($this->w - $this->original_lMargin - $this->original_rMargin) / 3);
      $style = array(
        'position' => $this->rtl ? 'R' : 'L',
        'align' => $this->rtl ? 'R' : 'L',
        'stretch' => false,
        'fitwidth' => true,
        'cellfitalign' => '',
        'border' => false,
        'padding' => 0,
        'fgcolor' => array(0, 0, 0),
        'bgcolor' => false,
        'text' => false
      );
      $this->write1DBarcode($barcode, 'C128', '', $curY + $lineWidth, '', (($this->footer_margin / 3) - $lineWidth), 0.3, $style, '');
    }
    $widthPage = isset($this->l['w_page']) ? $this->l['w_page'] . ' ' : '';
    if (empty($this->pagegroups)) {
      $pagenumtxt = $widthPage . $this->getAliasNumPage() . ' / ' . $this->getAliasNbPages();
    }
    else {
      $pagenumtxt = $widthPage . $this->getPageNumGroupAlias() . ' / ' . $this->getPageGroupAlias();
    }
    // $this->SetY($cur_y);
    $this->SetFontSize(10);
    $this->SetY(-35);
    //Print page number
    //  if(defined($this->footertext)==true AND $this->footertext !=='')
    //  {
    //$this->Cell($this->w - $this->original_lMargin - $this->original_rMargin, 0, '', 'T', 0, 'C');
    //  $this->Ln();
    $this->Line($this->original_lMargin, $this->h - 36, $this->w - $this->original_lMargin, $this->h - 36);
    $this->writeHTML($this->footertext, true, false, true, false, 'J');
    //	$this->Cell(0, 0, $this->footertext, 'T', 0, 'C');
    //  }
    $this->Ln();
    if ($this->getRTL()) {
      $this->SetX($this->original_rMargin);
      $this->Cell(0, 0, $pagenumtxt, 'T', 0, 'L');
    }
    else {
      $this->SetX($this->original_lMargin);
      $this->Cell(0, 0, $this->getAliasRightShift() . $pagenumtxt, '', 0, 'C');
    }
  }

  private function setImage($headerdata) {
    $imgtype = TCPDF_IMAGES::getImageFileType(K_PATH_IMAGES . $headerdata['logo']);

    if (($imgtype === 'eps') OR ( $imgtype === 'ai')) {
      $this->ImageEps(K_PATH_IMAGES . $headerdata['logo'], '', '', $headerdata['logo_width']);
    }
    elseif ($imgtype === 'svg') {
      $this->ImageSVG(K_PATH_IMAGES . $headerdata['logo'], '', '', $headerdata['logo_width']);
    }
    else {
      $this->Image(K_PATH_IMAGES . $headerdata['logo'], '', '', $headerdata['logo_width']);
    }
  }

}
